<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GigsTm - Profile Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="userform.css">
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <img src="./GigsTm_files/lgo_project1.png" alt="GigsTM" width="auto" height="50">
            </div>

            <div class="user-profile">
                <div class="user-avatar">
                    <img id="user-photo" src="https://ui-avatars.com/api/?name=User&background=random" alt="User Avatar">
                </div>
                <h3 class="user-name" id="user-display-name">Welcome Back!</h3>
                <p id="user-email-display" class="user-email">user@example.com</p>
            </div>

            <div class="contact-info">
                <!-- <h3>Account Details</h3> -->
                <div class="contact-detail">
                    <label><i class="fas fa-envelope"></i> Email Address</label>
                    <span id="user-email" class="user-email">Loading...</span>
                </div>
                <div class="contact-detail">
                    <label><i class="fas fa-phone"></i> Phone Number</label>
                    <span id="user-phone">Not provided</span>
                </div>
                <div class="contact-detail">
                <a href="dashboard.html">Dashboard</a>
                </div>
            </div>
        </div>

        <div class="main-content">
            <form id="profile-form">
                <div class="form-grid">
                    <!-- Name, Email, Mobile Row -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">Your Name *</label>
                            <input type="text" id="name" name="name" placeholder="GigsTM Admin" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Your Email *</label>
                            <input type="email" id="email" name="email" placeholder="admin@gmail.com" required>
                        </div>
                        <div class="form-group">
                            <label for="mobile">Your Mobile *</label>
                            <input type="tel" id="mobile" name="mobile" placeholder="7878787878" required>
                        </div>
                    </div>

                    <!-- Job Role Row -->
                    <div class="form-row single">
                        <div class="form-group">
                            <label for="job-role">Job Role</label>
                            <input type="text" id="job-role" name="jobRole" placeholder="Enter job role">
                        </div>
                    </div>

                    <!-- Gender, DOB, Profile Image Row -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" name="gender">
                                <option value="">-- Select Gender --</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dob">Your DOB</label>
                            <input type="date" id="dob" name="dob" class="date-input">
                        </div>
                        <div class="form-group">
                            <label for="profile-image">Profile Image</label>
                            <div class="file-input">
                                <input type="file" id="profile-image" name="profile-image" accept="image/*" style="display: none;">
                                <button type="button" class="file-btn" onclick="document.getElementById('profile-image').click()">
                                    <i class="fas fa-upload"></i> Choose File
                                </button>
                                <span class="file-status" id="profile-status">No file chosen</span>
                            </div>
                        </div>
                    </div>

                    <!-- Aadhaar and Pan Card Row -->
                    <div class="form-row double">
                        <div class="form-group">
                            <label for="aadhaar">Enter Aadhaar Card No.</label>
                            <input type="text" id="aadhaar" name="aadhaar" placeholder="Enter aadhaar card no." maxlength="12">
                        </div>
                        <div class="form-group">
                            <label for="pan">Enter Pan Card No.</label>
                            <input type="text" id="pan" name="pan" placeholder="Enter pan card no." maxlength="10" style="text-transform: uppercase;">
                        </div>
                    </div>

                    <!-- Upload Cards Row -->
                    <div class="form-row double">
                        <div class="form-group">
                            <label for="aadhaar-upload">Upload Aadhaar Card</label>
                            <div class="file-input">
                                <input type="file" id="aadhaar-file" name="aadhaar-file" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                                <button type="button" class="file-btn" onclick="document.getElementById('aadhaar-file').click()">Choose File</button>
                                <span class="file-status" id="aadhaar-status">No file chosen</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pan-upload">Upload Pan Card</label>
                            <div class="file-input">
                                <input type="file" id="pan-file" name="pan-file" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                                <button type="button" class="file-btn" onclick="document.getElementById('pan-file').click()">Choose File</button>
                                <span class="file-status" id="pan-status">No file chosen</span>
                            </div>
                        </div>
                    </div>

                    <!-- Country, State, City Row -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="country">Country</label>
                            <select id="country" name="country">
                                <option value="">-- Select Country --</option>
                                <option value="india">India</option>
                                <option value="usa">USA</option>
                                <option value="uk">UK</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <select id="state" name="state">
                                <option value="">-- Select State --</option>
                                <option value="maharashtra">Maharashtra</option>
                                <option value="gujarat">Gujarat</option>
                                <option value="delhi">Delhi</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="city">City</label>
                            <select id="city" name="city">
                                <option value="">Select City</option>
                                <option value="mumbai">Mumbai</option>
                                <option value="pune">Pune</option>
                                <option value="delhi">Delhi</option>
                            </select>
                        </div>
                    </div>

                    <!-- Address Row -->
                    <div class="form-row double">
                        <div class="form-group">
                            <label for="address1">Address Line 1</label>
                            <input type="text" id="address1" name="address1" placeholder="Address line 1">
                        </div>
                        <div class="form-group">
                            <label for="address2">Address Line 2</label>
                            <input type="text" id="address2" name="address2" placeholder="Address line 2">
                        </div>
                    </div>

                    <!-- Pincode Row -->
                    <div class="form-row single">
                        <div class="form-group">
                            <label for="pincode">Pincode</label>
                            <input type="text" id="pincode" name="pincode" placeholder="Pincode" style="max-width: 300px;" maxlength="6">
                        </div>
                    </div>

                    <!-- Resume Upload Row -->
                    <div class="form-row single">
                        <div class="form-group">
                            <label for="resume">Resume</label>
                            <div class="file-input">
                                <input type="file" id="resume-file" name="resume-file" accept=".pdf,.doc,.docx" style="display: none;">
                                <button type="button" class="file-btn" onclick="document.getElementById('resume-file').click()">Choose File</button>
                                <span class="file-status" id="resume-status">No file chosen</span>
                            </div>
                        </div>
                    </div>

                    <!-- About Section -->
                    <div class="form-row single">
                        <div class="form-group">
                            <label for="about">About</label>
                            <textarea id="about" name="about" placeholder="Type your message"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Auth Status and Controls -->
                <div class="form-footer">
                    <div class="user-session-info">
                        <div id="auth-status">
                            <i class="fas fa-user-circle"></i>
                            <div class="user-details">
                                <div id="logged-in-name" class="user-name">Welcome, Guest</div>
                                <div id="logged-in-email" class="user-email">Not signed in</div>
                            </div>
                        </div>
                        <div id="message-container"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="logout-btn" onclick="signOutUser()" title="Click to logout">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                        <button type="submit" id="submit-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

<script>
    // Firebase configuration and initialization
    (function() {
        const firebaseConfig = {
            apiKey: "AIzaSyDSzL3kP_1jKuYzn4YgZNKsKizsl7fUXjE",
            authDomain: "gigstm-12345.firebaseapp.com",
            projectId: "gigstm-12345",
            storageBucket: "gigstm-12345.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }
    })();

    // File input handlers
    document.getElementById('profile-image').addEventListener('change', function(e) {
        updateFileStatus('profile-status', e.target.files[0]);
    });
        document.getElementById('profile-image').addEventListener('change', function(e) {
            updateFileStatus('profile-status', e.target.files[0]);
        });

        document.getElementById('aadhaar-file').addEventListener('change', function(e) {
            updateFileStatus('aadhaar-status', e.target.files[0]);
        });

        document.getElementById('pan-file').addEventListener('change', function(e) {
            updateFileStatus('pan-status', e.target.files[0]);
        });

        document.getElementById('resume-file').addEventListener('change', function(e) {
            updateFileStatus('resume-status', e.target.files[0]);
        });

        function updateFileStatus(statusId, file) {
            const statusElement = document.getElementById(statusId);
            if (file) {
                statusElement.textContent = file.name;
                statusElement.style.color = '#27ae60';
            } else {
                statusElement.textContent = 'No file chosen';
                statusElement.style.color = '#666';
            }
        }

        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            container.innerHTML = message;
            container.className = type;
            container.style.display = 'block';
            
            // Auto hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    container.style.display = 'none';
                }, 5000);
            }
        }

        function setLoadingState(isLoading) {
            const submitBtn = document.getElementById('submit-btn');
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner"></span> Submitting...';
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // remove prefix
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function validateForm() {
            const requiredFields = ['name', 'email', 'mobile'];
            let isValid = true;
            
            for (let fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.style.borderColor = '#e74c3c';
                    isValid = false;
                } else {
                    field.style.borderColor = '#e0e0e0';
                }
            }
            
            return isValid;
        }

        document.getElementById("profile-form").addEventListener("submit", async function (e) {
            e.preventDefault();
            
            if (!validateForm()) {
                showMessage('Please fill in all required fields.', 'error');
                return;
            }

            setLoadingState(true);
            showMessage('Submitting form, please wait...', 'loading');

            try {
                const formData = new FormData();
                
                // Add all form fields with correct names to match Apps Script
                formData.append('name', document.getElementById('name').value);
                formData.append('email', document.getElementById('email').value);
                formData.append('mobile', document.getElementById('mobile').value);
                formData.append('job-role', document.getElementById('job-role').value);
                formData.append('gender', document.getElementById('gender').value);
                formData.append('dob', document.getElementById('dob').value);
                formData.append('aadhaar', document.getElementById('aadhaar').value);
                formData.append('pan', document.getElementById('pan').value);
                formData.append('country', document.getElementById('country').value);
                formData.append('state', document.getElementById('state').value);
                formData.append('city', document.getElementById('city').value);
                formData.append('address1', document.getElementById('address1').value);
                formData.append('address2', document.getElementById('address2').value);
                formData.append('pincode', document.getElementById('pincode').value);
                formData.append('about', document.getElementById('about').value);

                // Handle file uploads with better error handling
                const profileFile = document.getElementById("profile-image").files[0];
                const aadhaarFile = document.getElementById("aadhaar-file").files[0];
                const panFile = document.getElementById("pan-file").files[0];
                const resumeFile = document.getElementById("resume-file").files[0];

                if (profileFile) {
                    try {
                        const profileBase64 = await toBase64(profileFile);
                        formData.append("profileBase64", profileBase64);
                        formData.append("profileFileName", profileFile.name);
                        formData.append("profileMimeType", profileFile.type);
                    } catch (error) {
                        console.error("Profile image conversion error:", error);
                        showMessage('Error processing profile image. Please try again.', 'error');
                        setLoadingState(false);
                        return;
                    }
                }

                if (aadhaarFile) {
                    try {
                        const aadhaarBase64 = await toBase64(aadhaarFile);
                        formData.append("aadhaarBase64", aadhaarBase64);
                        formData.append("aadhaarFileName", aadhaarFile.name);
                        formData.append("aadhaarMimeType", aadhaarFile.type);
                    } catch (error) {
                        console.error("Aadhaar file conversion error:", error);
                        showMessage('Error processing Aadhaar file. Please try again.', 'error');
                        setLoadingState(false);
                        return;
                    }
                }

                if (panFile) {
                    try {
                        const panBase64 = await toBase64(panFile);
                        formData.append("panBase64", panBase64);
                        formData.append("panFileName", panFile.name);
                        formData.append("panMimeType", panFile.type);
                    } catch (error) {
                        console.error("PAN file conversion error:", error);
                        showMessage('Error processing PAN file. Please try again.', 'error');
                        setLoadingState(false);
                        return;
                    }
                }

                if (resumeFile) {
                    try {
                        const resumeBase64 = await toBase64(resumeFile);
                        formData.append("resumeBase64", resumeBase64);
                        formData.append("resumeFileName", resumeFile.name);
                        formData.append("resumeMimeType", resumeFile.type);
                    } catch (error) {
                        console.error("Resume file conversion error:", error);
                        showMessage('Error processing resume file. Please try again.', 'error');
                        setLoadingState(false);
                        return;
                    }
                }

                // Add timestamp for debugging
                formData.append("timestamp", new Date().toISOString());

                console.log("Submitting form data...");
                
                // Log form data for debugging
                console.log("Form data being sent:");
                for (let [key, value] of formData.entries()) {
                    if (key.includes('Base64')) {
                        console.log(key + ": [Base64 data, length: " + value.length + "]");
                    } else {
                        console.log(key + ":", value);
                    }
                }

                const response = await fetch('https://script.google.com/macros/s/AKfycbwyYEyxJPcttm_AGNTC3VZLn6s470x7g236Hn9gRhFQtsLE40RFDYz87dApLcnUUdHN/exec', {
                    method: "POST",
                    body: formData,
                });

                console.log("Response status:", response.status);
                console.log("Response headers:", response.headers);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Response data:", data);

                if (data.success || data.result === 'success') {
                    showMessage('Form submitted successfully! Your data has been saved.', 'success');
                    // Optionally reset form
                    // this.reset();
                } else {
                    throw new Error(data.error || data.message || 'Unknown error occurred');
                }

            } catch (error) {
                console.error("Submission error:", error);
                let errorMessage = 'Submission failed. ';
                
                if (error.message.includes('No item with the given ID')) {
                    errorMessage += 'Google Apps Script configuration issue. Please check the script permissions and sharing settings.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'Network error. Please check your internet connection and try again.';
                } else {
                    errorMessage += error.message || 'Please try again.';
                }
                
                showMessage(errorMessage, 'error');
            } finally {
                setLoadingState(false);
            }
        });

        function signOutUser() {
            console.log('Sign out initiated');
            if (!firebase.auth().currentUser) {
                console.log('No user is currently signed in');
                window.location.href = 'index.html';
                return;
            }
            
            firebase.auth().signOut().then(() => {
                // Sign-out successful
                console.log('User signed out successfully');
                // Clear any remaining auth state
                window.localStorage.removeItem('firebase:authUser:' + firebase.app().options.apiKey + ':[DEFAULT]');
                // Redirect to index.html after successful sign out
                window.location.href = 'index.html';
            }).catch((error) => {
                // An error happened
                console.error('Error signing out:', error);
                alert('Error signing out: ' + (error.message || 'Unknown error occurred'));
            });
        }

        // Initialize Firebase Auth
        function initializeAuth() {
            console.log('Initializing auth state listener...');
            return firebase.auth().onAuthStateChanged(function(user) {
                console.log('Auth state changed callback triggered');
                console.log('Auth state changed:', user);
                
                const loggedInName = document.getElementById('logged-in-name');
                const loggedInEmail = document.getElementById('logged-in-email');
                const authStatus = document.getElementById('auth-status');
                
                if (user) {
                    // User is signed in
                    console.log('User is signed in:', user);
                    
                    // Update sidebar
                    if (user.displayName) {
                        document.getElementById('user-display-name').textContent = user.displayName;
                    }
                    
                    if (user.email) {
                        document.getElementById('user-email-display').textContent = user.email;
                        document.getElementById('user-email').textContent = user.email;
                        document.getElementById('email').value = user.email;
                    }
                    
                    if (user.phoneNumber) {
                        document.getElementById('user-phone').textContent = user.phoneNumber;
                        document.getElementById('mobile').value = user.phoneNumber;
                    }
                    
                    if (user.photoURL) {
                        document.getElementById('user-photo').src = user.photoURL;
                    }
                    
                    // Update footer
                    const displayName = user.displayName || user.email.split('@')[0] || 'User';
                    loggedInName.textContent = `Hi, ${displayName}`;
                    loggedInEmail.textContent = user.email || 'No email provided';
                    authStatus.style.borderLeft = '4px solid #28a745';
                    document.querySelector('#auth-status i').style.color = '#28a745';
                    
                } else {
                    // No user is signed in
                    console.log('No user is signed in');
                    
                    // Reset UI
                    document.getElementById('user-display-name').textContent = 'Welcome Back!';
                    document.getElementById('user-email-display').textContent = 'user@example.com';
                    document.getElementById('user-email').textContent = 'Loading...';
                    document.getElementById('user-phone').textContent = 'Not provided';
                    
                    // Update footer
                    loggedInName.textContent = 'Welcome, Guest';
                    loggedInEmail.textContent = 'Not signed in';
                    authStatus.style.borderLeft = '4px solid #dc3545';
                    document.querySelector('#auth-status i').style.color = '#dc3545';
                    
                    // Redirect to login page if not already there
                    if (!window.location.pathname.endsWith('login.html')) {
                        window.location.href = 'login.html';
                    }
                }
            });
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            try {
                console.log('Initializing Firebase...');
                // Small delay to ensure Firebase is fully loaded
                setTimeout(() => {
                    console.log('Initializing auth...');
                    initializeAuth();
                }, 100);
            } catch (error) {
                console.error('Initialization error:', error);
                showMessage('Failed to initialize the application. Please refresh the page.', 'error');
            }
        });
    </script>
</body>

</html>